<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SpaIot Library: spaiot-lib</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SpaIot Library
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">spaiot-lib </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_README"></a>Supervision and Control library for Intxx PxxxSPA with an ESP8266 or ESP32</p>
<p ><a href="https://github.com/epsilonrt/spaiot-lib/releases"><img src="https://img.shields.io/github/v/release/epsilonrt/spaiot-lib?include_prereleases" alt="GitHub release (latest by date including pre-releases)" class="inline"/></a> <a href="https://github.com/epsilonrt/spaiot-lib/actions/workflows/build.yml"><img src="https://github.com/epsilonrt/spaiot-lib/actions/workflows/build.yml/badge.svg" alt="Build" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/epsilonrt/spaiot-lib/actions/workflows/build-test.yml"><img src="https://github.com/epsilonrt/spaiot-lib/actions/workflows/build-test.yml/badge.svg" alt="BuildTest" style="pointer-events: none;" class="inline"/></a> <a href="https://github.com/epsilonrt/spaiot-lib/actions/workflows/unit-test.yml"><img src="https://github.com/epsilonrt/spaiot-lib/actions/workflows/unit-test.yml/badge.svg" alt="UnitTest" style="pointer-events: none;" class="inline"/></a></p>
<p ><a href="https://registry.platformio.org/libraries/epsilonrt/spaiot-lib"><img src="https://badges.registry.platformio.org/packages/epsilonrt/library/spaiot-lib.svg" alt="PlatformIO Registry" style="pointer-events: none;" class="inline"/></a> <a href="#"><img src="https://img.shields.io/badge/Platform-Espressif8266-orange" alt="Platform ESP8266" class="inline"/></a> <a href="#"><img src="https://img.shields.io/badge/Platform-Espressif32-orange" alt="Platform ESP32" class="inline"/></a> <a href="https://www.arduino.cc/"><img src="https://img.shields.io/badge/Framework-Arduino-blue" alt="Framework" class="inline"/></a></p>
<hr  />
<p >This projet aims to add remote supervision and control ability to the Intxx PxxxSPA without altering the initial product.</p>
<p >The spaiot library must be associated with an electronic board which is placed between the control panel and the motor block, through its specific 5 pins connector.</p>
<p >The spaiot library: <br  />
</p><ul>
<li>is designed in C++ using the Arduino framework for ESP8266 and ESP32 chips, <br  />
</li>
<li>has been modularly designed to adapt to a large number of hardware and software choices, <br  />
</li>
<li>available in the <a href="https://registry.platformio.org/libraries/epsilonrt/spaiot-lib">PlatformIO Library Manager</a> and as a ZIP file for the Arduino IDE.</li>
</ul>
<p >spaiot-lib allows the integration of your Intxx PxxxSPA into your home automation (Internet of things). For example, associated with <a href="https://sinric.pro/">SinricPro</a>, spaiot-lib will order its spa in the voice using a Google Assistant, Amazon Alexa...</p>
<p ><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://raw.githubusercontent.com/epsilonrt/spaiot-lib/master/extras/images/by-nc-sa-small.png" alt="by-nc-sa.png" align="right" valign="top" class="inline"/> </a></p>
<p >spaiot-lib is based on Geoffroy Hubert's work on the DIYSCIP project. It is published with the same license: Creative Commons Attribution - No commercial use - sharing under the same conditions.</p>
<blockquote class="doxtable">
<p >:warning: <b>disclaimer:</b> This project is not affiliated with Intxx. </p>
</blockquote>
<p>It is distributed in the hope it will be useful but WITHOUT ANY WARRANTY. Any damaged on your spa or lost of original product warranty is in your own responsibility, including any consequences of using this project.</p>
<p >spaiot-lib provides the following features: <br  />
</p><ul>
<li>decoding frames on the connection between the control panel and the motor block to monitor the status of the spa, <br  />
</li>
<li>remote control of push buttons</li>
</ul>
<p >It is documented using <a href="https://www.doxygen.nl/index.html">doxygen</a> and delivered with <a href="https://github.com/epsilonrt/spaiot-lib/tree/master/examples">examples</a>. <a href="https://github.com/epsilonrt/spaiot-lib/tree/master/test">Unit tests</a> provide continuous integration and delivery (<a href="https://en.wikipedia.org/wiki/CI/CD">CI/CD</a>)</p>
<hr  />
<h1><a class="anchor" id="autotoc_md3"></a>
Installation</h1>
<h2><a class="anchor" id="autotoc_md4"></a>
VS Code &amp; PlatformIO</h2>
<ol type="1">
<li>Install <a href="https://code.visualstudio.com/">VS Code</a> <br  />
</li>
<li>Install <a href="https://platformio.org/platformio-ide">PlatformIO</a> <br  />
</li>
<li>Install <b>spaiot-lib</b> by using <a href="https://docs.platformio.org/en/latest/librarymanager/">Library Manager</a> <br  />
</li>
<li>Use included <a href="https://github.com/epsilonrt/spaiot-lib/blob/master/examples/platformio/platformio.ini">platformio.ini</a> file from examples to ensure that all dependent libraries will installed automaticly.</li>
</ol>
<p ><img src="https://raw.githubusercontent.com/epsilonrt/spaiot-lib/master/extras/images/platformio-install-spaiot.png" alt="spaiot-lib library manager" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md5"></a>
ArduinoIDE</h2>
<ol type="1">
<li>Install <a href="https://www.arduino.cc/en/software">Arduino IDE</a> <br  />
</li>
<li>Install Arduino core for <a href="https://github.com/esp8266/Arduino#installing-with-boards-manager">ESP8266</a> or <a href="https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html">ESP32</a> <br  />
</li>
<li>Download from GitHub, you should navigate to the top level of the <a href="https://github.com/epsilonrt/spaiot-lib">spaiot-lib project</a> and then a green "Code" download button will be visible on the right. Choose the Download ZIP option from the Code pull-down menu. <br  />
</li>
<li>Since you have downloaded the ZIP file, open your Arduino IDE, click on Sketch &gt; Include Library &gt; Add .ZIP Library. Choose the ZIP file you just downloaded，and if the library install correct, you will see Library added to your libraries in the notice window. Which means the library is installed successfully. <br  />
</li>
</ol>
<p >Then let's check if the library install correctly.</p>
<p >When you add the library successfully, there will be a demo in the Example. In this case, click on File &gt; Example &gt; spaiot-lib &gt; SpaSimple to open an example. <br  />
 Choose the highest CPU frequency (160MHz for ESP8266, 240MHz for ESP32) from the Tools &gt; CPU Frequency menu, click on the Verify button, if there's no error, congratulation, the library is installed perfectly.</p>
<p ><img src="https://raw.githubusercontent.com/epsilonrt/spaiot-lib/master/extras/images/arduino-example.png" alt="arduino ide" class="inline"/></p>
<hr  />
<h1><a class="anchor" id="autotoc_md7"></a>
Full user documentation</h1>
<p >The first-level API consists of the <a href="https://epsilonrt.github.io/spaiot-lib/class_spa_iot_1_1_control_panel.html">SpaIot::ControlPanel</a> class. For simply use, so just read the <a href="https://epsilonrt.github.io/spaiot-lib/class_spa_iot_1_1_control_panel.html">documentation</a> of this class.</p>
<p >For more advanced development, full documentation is available. <br  />
 Please see here for <a href="https://epsilonrt.github.io/spaiot-lib/">full user documentation</a></p>
<hr  />
<h1><a class="anchor" id="autotoc_md9"></a>
Examples</h1>
<p >See <a href="https://github.com/epsilonrt/spaiot-lib/tree/master/examples">examples</a> on GitHub</p>
<hr  />
<h1><a class="anchor" id="autotoc_md11"></a>
Usage</h1>
<ol type="1">
<li><p class="startli">Include SpaIot-Library (<code><a class="el" href="_spa_iot_8h_source.html">SpaIot.h</a></code>) and use the <a class="el" href="namespace_spa_iot.html" title="SpaIot name space.">SpaIot</a> namespace</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;SpaIot.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespace_spa_iot.html">SpaIot</a>;</div>
<div class="ttc" id="anamespace_spa_iot_html"><div class="ttname"><a href="namespace_spa_iot.html">SpaIot</a></div><div class="ttdoc">SpaIot name space.</div><div class="ttdef"><b>Definition:</b> bussettings.h:21</div></div>
</div><!-- fragment --></li>
<li><p class="startli">Declare a global reference on the <code>spa</code> control panel to get the singleton object</p>
<div class="fragment"><div class="line"><span class="comment">// Get the singleton object with your SPA configuration (here SCIP2SSP)</span></div>
<div class="line">ControlPanel &amp; spa = ControlPanel::singleton (<span class="stringliteral">&quot;SCIP2SSP&quot;</span>);</div>
</div><!-- fragment --><p class="startli">:warning: <b>disclaimer:</b> only one control panel <a href="https://en.wikipedia.org/wiki/Singleton_pattern">singleton</a> may exist.</p>
</li>
<li><p class="startli">In <code>setup()</code></p>
<div class="fragment"><div class="line"><span class="comment">// Start the control panel</span></div>
<div class="line">spa.begin();  <span class="comment">// IMPORTANT LINE!</span></div>
</div><!-- fragment --></li>
<li><p class="startli">In <code>loop()</code>, use API of the <a href="https://epsilonrt.github.io/spaiot-lib/class_spa_iot_1_1_control_panel.html">ControlPanel</a> class to do or read what you want</p>
<div class="fragment"><div class="line">uint16_t w;</div>
<div class="line"> </div>
<div class="line">w = spa.waterTemp(); <span class="comment">// Reading the temperature of the water</span></div>
<div class="line"><span class="keywordflow">if</span> (waterTemp != w) { <span class="comment">// If modified, it is displayed</span></div>
<div class="line">  waterTemp = w;</div>
<div class="line">  Serial.printf (<span class="stringliteral">&quot;waterTemp=%d&#39;C\n&quot;</span>, waterTemp);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (Serial.available() &gt; 0) { <span class="comment">// If the key pressed...</span></div>
<div class="line">  <span class="comment">// read the incoming byte:</span></div>
<div class="line">  <span class="keywordtype">int</span> c = Serial.read();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> ( (c == <span class="charliteral">&#39;P&#39;</span>) || (c == <span class="charliteral">&#39;p&#39;</span>)) { <span class="comment">// If the &#39;P&#39; key pressed, push the power button</span></div>
<div class="line">    spa.pushButton (Power);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md13"></a>
Configure the library according to the electronic part and the spa model</h1>
<p >spaiot-lib comes with hardware configurations of DIYSCIP boards and SSP-XXX and SJB-XXX SPA models : <br  />
</p><ol type="1">
<li><b>SCIP2SSP</b> &gt; DIYSCIP v2 and SSP-XXX spa</li>
<li><b>SCIP2SJB</b> &gt; DIYSCIP v2 and SJB-XXX spa <br  />
</li>
</ol>
<p >But it possible to adapt the hardware configuration with the HardwareSettings class which is an aggregation of classes:</p><ul>
<li>BusSettings that defines the configuration of the synchronous serial link,</li>
<li>LedSettings that defines the configuration of the LEDs of the spa,</li>
<li>ButtonSettings that defines the configuration of the buttons.</li>
</ul>
<p >You can see how to create your own configuration with the <a href="https://github.com/epsilonrt/spaiot-lib/blob/master/examples/SpaHwCustom/SpaHwCustom.ino">SpaHwCustom example</a></p>
<p >Before declare a global pointer on the spa control panel: <br  />
</p>
<ol type="1">
<li><p class="startli">Describe the pins used by the bus using a BusSettings constant</p>
<div class="fragment"><div class="line"><span class="comment">// My bus configuration :</span></div>
<div class="line"><span class="comment">// SDATA  -&gt; GPIO12</span></div>
<div class="line"><span class="comment">// SCLK   -&gt; GPIO14</span></div>
<div class="line"><span class="comment">// nWR    -&gt; GPIO13</span></div>
<div class="line"><span class="keyword">const</span> BusSettings MyBus (12, 14, 13);</div>
</div><!-- fragment --></li>
<li><p class="startli">Describe the bits of the frame used by LEDs using a list of LedSettings type constants</p>
<div class="fragment"><div class="line"><span class="comment">// My leds configuration (SSP)</span></div>
<div class="line"><span class="keyword">const</span> std::map&lt;int, LedSettings&gt; MyLeds = {</div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85afcf90bcaffa16815d107f79744841ecc">Power</a>,          LedSettings (0) },  <span class="comment">// Power        -&gt; A0</span></div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ae82e0f1d2e9f28c5f6e079fb0f4699f4">Heater</a>,         LedSettings (7) },  <span class="comment">// Heater       -&gt; A7</span></div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ac32b9779afa1f7482ebbb43678c6010c">HeatReached</a>,    LedSettings (9) },  <span class="comment">// HeatReached  -&gt; B1</span></div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ae0eb81dc75fac0a1701e8aa87917d8df">Bubble</a>,         LedSettings (10) }, <span class="comment">// Bubble       -&gt; B2</span></div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85a9016590d668a7ba7c7757b2f523e0813">Filter</a>,         LedSettings (12) }  <span class="comment">// Filter       -&gt; B4</span></div>
<div class="line">};</div>
<div class="ttc" id="anamespace_spa_iot_html_a02d4a743082b78154c3be333d5b0fc85a9016590d668a7ba7c7757b2f523e0813"><div class="ttname"><a href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85a9016590d668a7ba7c7757b2f523e0813">SpaIot::Filter</a></div><div class="ttdeci">@ Filter</div><div class="ttdoc">Filter Led or Button.</div><div class="ttdef"><b>Definition:</b> global.h:28</div></div>
<div class="ttc" id="anamespace_spa_iot_html_a02d4a743082b78154c3be333d5b0fc85ac32b9779afa1f7482ebbb43678c6010c"><div class="ttname"><a href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ac32b9779afa1f7482ebbb43678c6010c">SpaIot::HeatReached</a></div><div class="ttdeci">@ HeatReached</div><div class="ttdoc">Heat Reached Led (Green)</div><div class="ttdef"><b>Definition:</b> global.h:33</div></div>
<div class="ttc" id="anamespace_spa_iot_html_a02d4a743082b78154c3be333d5b0fc85ae0eb81dc75fac0a1701e8aa87917d8df"><div class="ttname"><a href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ae0eb81dc75fac0a1701e8aa87917d8df">SpaIot::Bubble</a></div><div class="ttdeci">@ Bubble</div><div class="ttdoc">Bubble Led or Button.</div><div class="ttdef"><b>Definition:</b> global.h:29</div></div>
<div class="ttc" id="anamespace_spa_iot_html_a02d4a743082b78154c3be333d5b0fc85ae82e0f1d2e9f28c5f6e079fb0f4699f4"><div class="ttname"><a href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ae82e0f1d2e9f28c5f6e079fb0f4699f4">SpaIot::Heater</a></div><div class="ttdeci">@ Heater</div><div class="ttdoc">Heater Led (Red) or Button.</div><div class="ttdef"><b>Definition:</b> global.h:32</div></div>
<div class="ttc" id="anamespace_spa_iot_html_a02d4a743082b78154c3be333d5b0fc85afcf90bcaffa16815d107f79744841ecc"><div class="ttname"><a href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85afcf90bcaffa16815d107f79744841ecc">SpaIot::Power</a></div><div class="ttdeci">@ Power</div><div class="ttdoc">Power Led or Button.</div><div class="ttdef"><b>Definition:</b> global.h:27</div></div>
</div><!-- fragment --></li>
<li><p class="startli">Describe buttons controllers and their pins with the corresponding class (here Cd4051) <br  />
</p>
<div class="fragment"><div class="line"><span class="comment">// My button controllers</span></div>
<div class="line">Cd4051 BtnCtrlA (<span class="stringliteral">&quot;U3&quot;</span>, 5, 4, 15, 16); <span class="comment">// A-&gt;GPIO5, B-&gt;GPIO4, C-&gt;GPIO15, INH-&gt;GPIO16</span></div>
<div class="line">Cd4051 BtnCtrlB (<span class="stringliteral">&quot;U4&quot;</span>, 5, 4, 15, 0);  <span class="comment">// A-&gt;GPIO5, B-&gt;GPIO4, C-&gt;GPIO15, INH-&gt;GPIO0</span></div>
</div><!-- fragment --></li>
<li><p class="startli">Describe the (bits used in the frame and controller) using a List of ButtonSettings constants <br  />
</p>
<div class="fragment"><div class="line"><span class="comment">// My buttons configuration (SSP)</span></div>
<div class="line"><span class="keyword">const</span> std::map&lt;int, ButtonSettings&gt; MyButtons = {</div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85a9016590d668a7ba7c7757b2f523e0813">Filter</a>,   ButtonSettings (BtnCtrlA, 1) },  <span class="comment">// Filter   -&gt; A1</span></div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ae0eb81dc75fac0a1701e8aa87917d8df">Bubble</a>,   ButtonSettings (BtnCtrlA, 3) },  <span class="comment">// Bubble   -&gt; A3</span></div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85a9a63f5b3808bb64caed3029d755bb5eb">TempDown</a>, ButtonSettings (BtnCtrlA, 7) },  <span class="comment">// TempDown -&gt; A7</span></div>
<div class="line"> </div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85afcf90bcaffa16815d107f79744841ecc">Power</a>,    ButtonSettings (BtnCtrlB, 2) },  <span class="comment">// Power    -&gt; B2</span></div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ae032fffb62d7b3fad28a346f68a32668">TempUp</a>,   ButtonSettings (BtnCtrlB, 4) },  <span class="comment">// TempUp   -&gt; B4</span></div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85a827dbec1053cf0675186f0e4d4f72e9c">TempUnit</a>, ButtonSettings (BtnCtrlB, 5) },  <span class="comment">// TempUnit -&gt; B5</span></div>
<div class="line">  { <a class="code hl_enumvalue" href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ae82e0f1d2e9f28c5f6e079fb0f4699f4">Heater</a>,   ButtonSettings (BtnCtrlB, 7) }   <span class="comment">// Heater   -&gt; B7</span></div>
<div class="line">};</div>
<div class="ttc" id="anamespace_spa_iot_html_a02d4a743082b78154c3be333d5b0fc85a827dbec1053cf0675186f0e4d4f72e9c"><div class="ttname"><a href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85a827dbec1053cf0675186f0e4d4f72e9c">SpaIot::TempUnit</a></div><div class="ttdeci">@ TempUnit</div><div class="ttdoc">Temperature Unity Button (°C/°F)</div><div class="ttdef"><b>Definition:</b> global.h:36</div></div>
<div class="ttc" id="anamespace_spa_iot_html_a02d4a743082b78154c3be333d5b0fc85a9a63f5b3808bb64caed3029d755bb5eb"><div class="ttname"><a href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85a9a63f5b3808bb64caed3029d755bb5eb">SpaIot::TempDown</a></div><div class="ttdeci">@ TempDown</div><div class="ttdoc">Temperature Down Button.</div><div class="ttdef"><b>Definition:</b> global.h:35</div></div>
<div class="ttc" id="anamespace_spa_iot_html_a02d4a743082b78154c3be333d5b0fc85ae032fffb62d7b3fad28a346f68a32668"><div class="ttname"><a href="namespace_spa_iot.html#a02d4a743082b78154c3be333d5b0fc85ae032fffb62d7b3fad28a346f68a32668">SpaIot::TempUp</a></div><div class="ttdeci">@ TempUp</div><div class="ttdoc">Temperature Up Button.</div><div class="ttdef"><b>Definition:</b> global.h:34</div></div>
</div><!-- fragment --></li>
<li><p class="startli">Finally Create the hardware configuration <br  />
</p>
<div class="fragment"><div class="line"><span class="comment">// My custom configuration</span></div>
<div class="line"><span class="keyword">const</span> HardwareSettings MyConfig (MyBus, MyLeds, MyButtons);</div>
</div><!-- fragment --></li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md15"></a>
How does SpaIot work ?</h1>
<h2><a class="anchor" id="autotoc_md16"></a>
Decoding frames</h2>
<p >Decoding requires only 3 GPIO pins of the ESP chip. These pins are connected to the SDATA, SCLK and nWR signals of the bus between the control panel and the motor block. These 3 signals constitutes a synchronous serial bus (similar to the SPI bus) that transmits frames consisting of 16-bit words. The words are composed of 2 bytes A and B. B is the most significant byte and it is transmitted first. Bytes are transmitted with the most significant bit first (left).</p>
<p >We can see in the image below the frame that corresponds to the command of the LEDs:</p>
<p ><img src="https://raw.githubusercontent.com/epsilonrt/spaiot-lib/master/extras/images/ledframe.png" alt="ledframe" class="inline"/></p>
<p >Decoding is implemented by the FrameDecoder class. This class makes it possible to recover mainly the following information:</p><ul>
<li>LED status using FrameDecoder::isPowerOn(), FrameDecoder::isFilterOn() ...</li>
<li>measured water and desired temperature using the FrameDecoder::waterTemp() et FrameDecoder::desiredTemp(),</li>
<li>error code displayed using the FrameDecoder::error() function</li>
</ul>
<p >The GPIO pins connected to the SCLK and nWR signals are used in interruption. That's why the Framedecoder class is a singleton. It is designed to be a base class and can not be instantiated directly. It will be used thanks to its ControlPanel derived class.</p>
<h2><a class="anchor" id="autotoc_md17"></a>
Control of push buttons</h2>
<p >The general idea is to "connect" an electronic switch to bypass the button on the control panel. Of course, this is not what is done because it would be necessary in this case to intervene on the control panel.</p>
<p >To find out how to do it, simply study the diagram below:</p>
<p ><img src="https://raw.githubusercontent.com/epsilonrt/spaiot-lib/master/extras/images/sch1_sregister.png" alt="sch1_sregister" class="inline"/></p>
<p >It is possible to see 2 integrated circuits, U1 and U2 which will store the 16 bits of the frame and apply their logic level to the correditional pins of U1 / U2. U1 memorizes least significant byte A, U2 the most significant byte B.</p>
<p >To play a push button:</p><ol type="1">
<li>The button must be selected by transmitting a 16-bit word that applies a low level to a pin of this push button,</li>
<li>Then put nWR in the top state,</li>
<li>Activates a pull-up resistance on SDATA,</li>
<li>Toggle the signal SDATA input,</li>
<li>Then after a delay of a few microseconds, to read the state of SDATA, which is connected to the other pin of the button.</li>
</ol>
<p >If SDATA is in the low level, the button selected in step 1 is pressed. For example, if we want to test if the S1-Filter button is pressed, you have to send a word with bit A1 to 0.</p>
<p >To be able to emulate pressing a button, it is necessary to reproduce this scheme on a board and replace the buttons with electronic switches.</p>
<p >MOSFET transistors can be used, multiplexer circuits... In version 2 of the board, the DIYSCIP project uses 2 multiplexer circuits 1 to 8 (4051) that allow to take into account any button connected to A0..A7 or B0..B7</p>
<p >spaiot-lib implements the button control with the Button class. Button uses the Abstract ButtonController class to make the connection between the button of the button and SDATA (SCOM actually). Thus, the developer will be able to create a derived class of ButtonController to implement his solution.</p>
<hr  />
 </div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
